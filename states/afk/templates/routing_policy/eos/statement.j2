{#
  NOT IMPLEMENTED:
    - origin-eq
    - afi-safi-in
    - next-hop-in

  MISSING IN OPENCONFIG:
    - large communities
    - match origin-as validity invalid

  TODO:
    - ext-community
#}

{# Device specific mapping #}

{% set PROTOCOLS = {
    "BGP": "bgp",
    "ISIS": "isis",
    "OSPF": "ospf",
    "OSPF3": "ospfv3",
    "STATIC": "static",
    "DIRECTLY_CONNECTED": "connected",
  }
%}

{% set L3_PROTOCOLS = {
    "IPV4": "ip",
    "IPV6": "ipv6",
}
%}

{% set ACTION = {
    "ACCEPT_ROUTE": "permit",
    "REJECT_ROUTE": "deny",
  }
%}

{# Configuration #}

route-map {{ route_map_name }} {{ ACTION[actions["config"]["policy-result"]] }} {{ sequence }}

{# Conditions #}

{% if conditions["match-prefix-set"] %}
  {% set prefix_set_mode = prefixes_set_mode[conditions["match-prefix-set"]["config"].get("prefix-set")] %}
  match {{ L3_PROTOCOLS[prefix_set_mode] }} address prefix-list {{ conditions["match-prefix-set"]["config"]["prefix-set"] }}

  {# Hardcoded to be ISO with SONiC template. TODO: remove once we have SONiC migrated to >= 202111 #}
  {% if route_map_name == "RM-CLOS-IN" and sequence == "10" and conditions["match-prefix-set"]["config"]["prefix-set"] == "PF-ANY_IPV6" %}
  continue
  {% endif %}
{% endif %}

{% if conditions["config"]["install-protocol-eq"] %}
  match source-protocol {{ PROTOCOLS[conditions["config"]["install-protocol-eq"]] }}
{% endif %}

{% if conditions["bgp-conditions"] and conditions["bgp-conditions"]["config"].get("med-eq") %}
  match metric {{ conditions["bgp-conditions"]["config"]["med-eq"] }}
{% endif %}

{% if conditions["bgp-conditions"] and conditions["bgp-conditions"]["config"].get("local-pref-eq") %}
  set local-preference {{ conditions["bgp-conditions"]["config"]["local-pref-eq"] }}
{% endif %}

{% if conditions["bgp-conditions"] and conditions["bgp-conditions"]["config"].get("community-set") %}
  match community {{ conditions["bgp-conditions"]["config"]["community-set"] }}
{% endif %}

{% if conditions["config"]["call-policy"] %}
  sub-route-map {{ conditions["config"]["call-policy"] }}
{% endif %}

{# Actions #}

{% if actions["bgp-actions"] and actions["bgp-actions"]["config"].get("set-route-origin") %}
  set origin {{ actions["bgp-actions"]["config"]["set-route-origin"] }}
{% endif %}

{% if actions["bgp-actions"] and actions["bgp-actions"]["config"].get("set-local-pref") %}
  set local-preference {{ actions["bgp-actions"]["config"]["set-local-pref"] }}
{% endif %}

{% if actions["bgp-actions"] and actions["bgp-actions"]["config"].get("set-next-hop") %}
  set ip next-hop {{ next_hop }}
{% endif %}

{% if actions["bgp-actions"] and actions["bgp-actions"]["config"].get("set-med") %}
  set metric {{ actions["bgp-actions"]["config"]["set-med"] }}
{% endif %}

{% if actions["bgp-actions"] and actions["bgp-actions"].get("set-as-path-prepend") %}
  {% set as_prepend_config = actions["bgp-actions"]["set-as-path-prepend"]["config"] %}
  set as-path prepend{{ (" " + as_prepend_config["asn"]|string) * as_prepend_config["repeat-n"] }}
{% endif %}

{% if actions["bgp-actions"] and actions["bgp-actions"].get("set-community") %}
  {# this one might need some python magic #}
  {# handle "set community none" and other well known communities #}
  {% if actions["bgp-actions"]["set-community"]["config"].get("method") == "INLINE" %}
  set community {{ actions["bgp-actions"]["set-community"]["inline"]["config"]["communities"]|join(" ") }}
  {% else %}
  set community community-list {{ actions["bgp-actions"]["set-community"]["reference"]["config"].get("community-set-ref") }}
  {% endif %}
{% endif %}
